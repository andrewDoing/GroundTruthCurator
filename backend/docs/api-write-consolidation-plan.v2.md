# API Write Consolidation Plan v2 — Explicit Keep/Remove Matrix

This update clarifies exactly which endpoints will remain and which will be removed as we consolidate all Ground Truth writes into two endpoints (SME and Curator). It also reiterates that the Curator import endpoint stays as a separate POST for creation, and that Cosmos `_etag` is used for optimistic concurrency.


## endpoint matrix

Legend
- Keep: endpoint remains as-is (minor schema expansion where noted)
- Remove: endpoint will be deleted; functionality moves into SME/Curator PUT if applicable

| Method | Path                                                          | Owner   | Action                      | Status | Notes                                           |
| ------ | ------------------------------------------------------------- | ------- | --------------------------- | ------ | ----------------------------------------------- |
| GET    | /v1/assignments/my                                            | SME     | List current assignments    | Keep   | Read-only                                       |
| POST   | /v1/assignments/self-serve                                    | SME     | Request new batch           | Keep   | Assignments creation; not a GT item write       |
| PUT    | /v1/assignments/{item_id}                                     | SME     | Update/approve item         | Keep   | Will accept references delta + optional etag    |
| POST   | /v1/ground-truths                                             | Curator | Bulk import (create)        | Keep   | Curator import remains a separate POST          |
| GET    | /v1/ground-truths/{datasetName}                               | Curator | List/filter items           | Keep   | Read-only                                       |
| PUT    | /v1/ground-truths/{datasetName}/{item_id}                     | Curator | Update item                 | Keep   | Will accept references delta + optional etag    |
| DELETE | /v1/ground-truths/{datasetName}                               | Curator | Delete dataset (admin)      | Keep   | Admin-only                                      |
| DELETE | /v1/ground-truths/{datasetName}/{item_id}                     | Curator | Hard-Delete item (admin)    | Keep   | Admin-only                                      |
| POST   | /v1/ground-truths/snapshot                                    | Curator | Create snapshot export      | Keep   | Writes to storage, not GT doc                   |
| POST   | /v1/ground-truths/{datasetName}/{item_id}/references          | Curator | Add references to item      | Remove | Fold into Curator PUT with references           |
| DELETE | /v1/ground-truths/{datasetName}/{item_id}/references/{ref_id} | Curator | Remove a specific reference | Remove | Fold into Curator/SME PUT via references        |
| GET    | /v1/ground-truths/stats                                       | Any     | Stats by status             | Keep   | Read-only                                       |


## request/response updates (for kept endpoints)

- SME PUT `/v1/assignments/{item_id}`
  - Add: optional `etag` in body, and accept `If-Match` header
  - Response includes updated `_etag`

- Curator PUT `/v1/ground-truths/{datasetName}/{item_id}`
  - Add: optional `etag` in body, and accept `If-Match` header
  - Response includes updated `_etag`

- Curator POST `/v1/ground-truths` (import)
  - Unchanged in path/method; clarify it’s for create/import only (no updates)


## cosmos concurrency

- `_etag` is system-generated by Cosmos. Clients do not set `_etag`; they read it from responses.
- On updates, we perform conditional replace using If-Match (from `etag` body field or `If-Match` header).


## validation and rules

- SME endpoint enforces assignment ownership and role-based field masks.


## code changes summary

- Remove reference-specific routes from `app/api/v1/ground_truths.py`.
- Expand PUT handlers in `assignments.py` and `ground_truths.py` to accept references + optional etag.
- Update unit tests accordingly.


## acceptance criteria

- Only two endpoints perform writes to GT items: SME PUT and Curator PUT.
- Curator POST import remains for create-only flows.
- Separate Delete endpoint for SME GT is removed and covered by SME PUT.
- Reference-specific endpoints are removed and covered by references in PUTs.
- ETag-based concurrency enforced (412 on mismatch);
- Unit tests added for etag mismatch.
